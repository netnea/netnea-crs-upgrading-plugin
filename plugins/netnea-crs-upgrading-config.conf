# OWASP CRS Plugin
# Plugin name: netnea-crs-upgrading-plugin
# Plugin description: Simplifies the CRS upgrading process.
# Rule ID block base: 9,525,000 (range is 1000, thus ID block base +1000)
# Plugin version: 1.0.0

# Generic rule to disable the plugin
#
# Plugins are enabled by default.
#
# They become active by placing them in the plugin folder. It is possible to
# control plugin activation via setting a variable. This can be done in the
# plugin config file here.
#
# The predefined variable name is meant to be "<plugin name>-plugin_enabled".
# For the netnea-crs-upgrading-plugin, this means it can be disabled by setting
# tx.netnea-crs-upgrading-plugin_enabled=0.
#
# Note that a global setting of this variable overrides the setting here.
# That means the "enabled" variable is only set by this rule if it has not
# been set before.
#
# Feel free to set the variable unconditionally here by replacing the
# SecRule line with an unconditional SecAction statement.
#
#SecRule &TX:netnea-crs-upgrading-plugin_enabled "@eq 0" \
#  "id:9525010,\
#  phase:1,\
#  pass,\
#  nolog,\
#  setvar:'tx.netnea-crs-upgrading-plugin_enabled=0'"

# Rule 9525100 enables the parallel mode of CRS3 and CRS4
# by removing the blocking rules of CRS4.
# It's step 1 of the upgrading process as described in the README.
#
SecAction \
  "id:9525100,\
   phase:1,\
   pass,\
   nolog,\
   noauditlog,\
   setvar:'tx.reporting_upgrading=upgrading-plugin running in parallel mode',\
   tag:'netnea-crs-upgrading-plugin',\
   ver:'netnea-crs-upgrading-plugin/1.0.0',\
   ctl:ruleRemoveById=8949110,ctl:ruleRemoveById=8959100,\
   ctl:ruleRemoveById=9525101-9525799"

# Step 2 of upgrading process:
# Rule 9525200 sets the percentage of requests that should run through CRS4
# A value 0, for example, means that all requests run through CRS3.
# A value of 100 means, all requests run through CRS4.
#
SecAction \
  "id:9525200,\
   phase:1,\
   pass,\
   nolog,\
   noauditlog,\
   tag:'netnea-crs-upgrading-plugin',\
   ver:'netnea-crs-upgrading-plugin/1.0.0',\
   setvar:tx.sampling_percentage_crs-upgrading=10"
