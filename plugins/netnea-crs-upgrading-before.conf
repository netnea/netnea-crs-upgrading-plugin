# OWASP CRS Plugin
# Plugin name: netnea-crs-upgrading-plugin
# Plugin description: Simplifies the CRS upgrading process.
# Rule ID block base: 9,527,000 (range is 1000, thus ID block base +1000)
# Plugin version: 1.0.0

# Generic rule to disable plugin
SecRule TX:netnea-crs-upgrading-plugin_enabled "@eq 0" "id:9527098,phase:1,pass,nolog,ctl:ruleRemoveById=9527100-9527999,ctl:ruleRemoveById=8900000-8999999"

# Enable CRS3 based on paths configured in paths_crs3.data
SecRule REQUEST_FILENAME "@pmFromFile paths_crs3.data" \
    "id:9527300,\
    phase:1,\
    pass,\
    nolog,\
    noauditlog,\
    setvar:'tx.reporting_upgrading=Enable CRS3 based on path %{MATCHED_VAR}',\
    tag:'netnea-crs-upgrading-plugin',\
    ver:'netnea-crs-upgrading-plugin/1.0.0',\
    ctl:ruleRemoveById=8900000-8999999,\
	ctl:ruleRemoveById=9527100-9527799"

# Enable CRS4 based on paths configured in paths_crs4.data
SecRule REQUEST_FILENAME "@pmFromFile paths_crs4.data" \
    "id:9527310,\
    phase:1,\
    pass,\
    nolog,\
    noauditlog,\
    setvar:'tx.reporting_upgrading=Enable CRS4 based on path %{MATCHED_VAR}',\
    tag:'netnea-crs-upgrading-plugin',\
    ver:'netnea-crs-upgrading-plugin/1.0.0',\
    ctl:ruleRemoveById=901000-999999,\
	ctl:ruleRemoveById=9527100-9527799"

### Used if CRS3 and CRS4 are run in Sampling Mode: ###
SecRule UNIQUE_ID "@rx ^[a-f]*([0-9])[a-f]*([0-9])" \
    "id:9527410,\
    phase:1,\
    pass,\
    capture,\
    t:sha1,t:hexEncode,\
    nolog,\
    tag:'netnea-crs-upgrading-plugin',\
    ver:'netnea-crs-upgrading-plugin/1.0.0',\
    setvar:'TX.sampling_rnd100_crs-upgrading=%{TX.1}%{TX.2}'"

SecRule TX:sampling_rnd100_crs-upgrading "!@lt %{tx.sampling_percentage_crs-upgrading}" \
    "id:9527450,\
    phase:1,\
    pass,\
    nolog,\
    noauditlog,\
    skip:1,\
    tag:'netnea-crs-upgrading-plugin',\
    ver:'netnea-crs-upgrading-plugin/1.0.0',\
    setvar:'tx.reporting_upgrading=No explicit configured path found. Enabling sampling: Running CRS3 because chosen percentage %{TX.sampling_percentage_crs-upgrading} is lower than random number %{TX.sampling_rnd100_crs-upgrading}',\
    ctl:ruleRemoveById=8900000-8999999"

SecRule TX:sampling_rnd100_crs-upgrading "@unconditionalMatch" \
    "id:9527460,\
    phase:1,\
    pass,\
    nolog,\
    noauditlog,\
    skip:1,\
    tag:'netnea-crs-upgrading-plugin',\
    ver:'netnea-crs-upgrading-plugin/1.0.0',\
    setvar:'tx.reporting_upgrading=No explicit configured path found. Enabling sampling: Running CRS4 because chosen percentage %{TX.sampling_percentage_crs-upgrading} is higher than random number %{TX.sampling_rnd100_crs-upgrading}',\
    ctl:ruleRemoveById=901000-999999"
